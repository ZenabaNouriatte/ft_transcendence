# nginx.conf.tmpl
events {}

http {
  # HTTP -> HTTPS redirect
  server {
    listen 80;
    return 301 https://$host:8443$request_uri;
  }

  # WebSocket helpers
  map $http_upgrade $connection_upgrade { 
    default upgrade; 
    '' close; 
  }
  map $request_id $req_id { 
    default $request_id; 
  }

  # JSON logs
  log_format json escape=json
    '{ "time":"$time_local","remote_addr":"$remote_addr","request_id":"$req_id",'
    '"method":"$request","status":$status,"body_bytes_sent":$body_bytes_sent,'
    '"request_time":$request_time,"upstream_time":"$upstream_response_time" }';

  server {
    listen 443 ssl;
    server_name _;

    # TLS configuration
    ssl_certificate     /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    client_max_body_size 10m;
    proxy_buffering off;

    # Health check endpoint
    location = /healthz { 
      return 200; 
    }

    # ── Frontend (static site) ──
    location = /index.html { 
      proxy_pass http://frontend:80/index.html; 
    }
    location = /ws-test.html { 
      proxy_pass http://frontend:80/ws-test.html; 
    }
    location / {
      proxy_pass http://frontend:80;
      proxy_http_version 1.1;
    }

    # ── API -> gateway ──
    location /api/ {
      proxy_pass http://gateway:8000;
      proxy_http_version 1.1;
      proxy_read_timeout 60s;

      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme; 

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header X-Content-Type-Options;
      proxy_hide_header X-Frame-Options;
      proxy_hide_header Referrer-Policy;
      proxy_hide_header Cross-Origin-Resource-Policy;
    }

    # ── Uploaded files -> gateway ──
    location /uploads/ {
      proxy_pass http://gateway:8000;
      proxy_http_version 1.1;
      proxy_read_timeout 30s;

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header X-Content-Type-Options;
      proxy_hide_header X-Frame-Options;
      proxy_hide_header Referrer-Policy;
      proxy_hide_header Cross-Origin-Resource-Policy;
    }

    # ── Metrics -> gateway ──
    location = /metrics {
      proxy_pass http://gateway:8000/metrics;
      proxy_http_version 1.1;
      proxy_read_timeout 30s;
    }

    # ── WebSocket -> gateway ──
    location = /ws {
      access_log /var/log/nginx/websocket.log;
      proxy_pass http://gateway:8000;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header Host $host;

      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_read_timeout 60s;
      proxy_send_timeout 60s; 

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header X-Content-Type-Options;
      proxy_hide_header X-Frame-Options;
      proxy_hide_header Referrer-Policy;
      proxy_hide_header Cross-Origin-Resource-Policy;
    }

    # ── Grafana : https://localhost:8443/grafana/ ──
    # Redirige la racine Grafana vers le dashboard ft-core
    location = /grafana/ {
      return 302 https://$http_host/grafana/d/bf2jrbxbv198gc/ft-e28093-core-overview?orgId=1&refresh=10s;
    }

    location /grafana/ {
      proxy_pass http://grafana:3000;
      proxy_http_version 1.1;

      proxy_set_header X-Forwarded-Prefix /grafana;

      proxy_set_header Host $host;
#      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
      
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_redirect off;
    }

    # Interdire l'accès public à l'endpoint metrics de Grafana
    location = /grafana/metrics {
      return 403;
    }


    # ── Prometheus : https://localhost:8443/prometheus/ ──
    location /prometheus/ {
      rewrite ^/prometheus/(.*) /$1 break;
      proxy_pass http://prometheus:9090;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ── Kibana : https://localhost:8443/kibana/ ──
    location /kibana/ {
      proxy_pass http://kibana:5601;
      proxy_http_version 1.1;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;

      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_read_timeout 90s;
      proxy_redirect off;
    }

    # ── Alertmanager : https://localhost:8443/alertmanager/ ──
    location /alertmanager/ {
      rewrite ^/alertmanager/(.*) /$1 break;
      proxy_pass http://alertmanager:9093;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    access_log /var/log/nginx/access.json json;
  }
}
