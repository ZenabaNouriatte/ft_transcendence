# nginx.conf.tmpl
events {}

http {
  # HTTP -> HTTPS
  server {
    listen 80;
    return 301 https://$host:8443$request_uri;
  }

  # Helpers WS
  map $http_upgrade $connection_upgrade { default upgrade; '' close; }
  map $request_id    $req_id            { default $request_id; }

  # Logs JSON
  log_format json escape=json
    '{ "time":"$time_local","remote_addr":"$remote_addr","request_id":"$req_id",'
    '"method":"$request","status":$status,"body_bytes_sent":$body_bytes_sent,'
    '"request_time":$request_time,"upstream_time":"$upstream_response_time" }';

  server {
    listen 443 ssl http2;
    server_name _;

    # TLS
    ssl_certificate     /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Sécurité + CSP compatible remote + WS
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; connect-src 'self' https: wss:; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'" always;

    # Headers communs vers upstreams
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID      $req_id;

    client_max_body_size 10m;
    proxy_buffering off;

    # Health du proxy
    location = /healthz { return 200; }

    # ── Frontend (tout le site statique) ──
    # On délègue entièrement au service `frontend`
    location = /index.html { proxy_pass http://frontend:80/index.html; }
    location = /ws-test.html { proxy_pass http://frontend:80/ws-test.html; }
    location / {
      proxy_pass http://frontend:80;
      proxy_http_version 1.1;
      # SPA: le serveur `frontend` rendra index.html pour les routes client si configuré ainsi
    }

    # ── API -> gateway ──
    location /api/ {
      proxy_pass http://gateway:8000;
      proxy_http_version 1.1;
      proxy_read_timeout 60s;
    }

    # ── Metrics -> gateway ──
    location = /metrics {
      proxy_pass http://gateway:8000/metrics;
      proxy_http_version 1.1;
      proxy_read_timeout 30s;
      # Optionnel: restreindre l'accès
      # allow 127.0.0.1; allow ::1; allow 172.16.0.0/12; deny all;
    }

    # ── WebSocket -> gateway ──
    location = /ws {
      access_log /var/log/nginx/websocket.log;
      proxy_pass http://gateway:8000/ws;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_read_timeout  86400s;
      proxy_send_timeout  86400s;
    }

    access_log /var/log/nginx/access.json json;
  }
}

