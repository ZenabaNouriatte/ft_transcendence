# nginx.conf.tmpl
events {}

http {
  # HTTP -> HTTPS
  server {
    listen 80;
    return 301 https://$host:8443$request_uri;
  }

  # Helpers WS
  map $http_upgrade $connection_upgrade { default upgrade; '' close; }
  map $request_id    $req_id            { default $request_id; }

  # Logs JSON
  log_format json escape=json
    '{ "time":"$time_local","remote_addr":"$remote_addr","request_id":"$req_id",'
    '"method":"$request","status":$status,"body_bytes_sent":$body_bytes_sent,'
    '"request_time":$request_time,"upstream_time":"$upstream_response_time" }';

  server {
    listen 443 ssl;
    server_name _;

    # TLS
    ssl_certificate     /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Sécurité + CSP compatible remote + WS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    client_max_body_size 10m;
    proxy_buffering off;

    # Health du proxy
    location = /healthz { return 200; }

    # ── Frontend  ──
    location = /index.html { proxy_pass http://frontend:80/index.html; }
    location = /ws-test.html { proxy_pass http://frontend:80/ws-test.html; }
    location / {
      proxy_pass http://frontend:80;
      proxy_http_version 1.1;
    }

    # ── API -> gateway ──
    location /api/ {
      proxy_pass http://gateway:8000;
      proxy_http_version 1.1;
      proxy_read_timeout 60s;

      proxy_set_header Authorization $http_authorization;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme; 

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header X-Content-Type-Options;
      proxy_hide_header X-Frame-Options;
      proxy_hide_header Referrer-Policy;
      proxy_hide_header Cross-Origin-Resource-Policy;
    }

    # ── Uploaded files -> gateway ──
    location /uploads/ {
      proxy_pass http://gateway:8000;
      proxy_http_version 1.1;
      proxy_read_timeout 30s;

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header X-Content-Type-Options;
      proxy_hide_header X-Frame-Options;
      proxy_hide_header Referrer-Policy;
      proxy_hide_header Cross-Origin-Resource-Policy;
    }

    # ── Metrics -> gateway ──
    location = /metrics {
      proxy_pass http://gateway:8000/metrics;
      proxy_http_version 1.1;
      proxy_read_timeout 30s;

    }

    # ── WebSocket -> gateway ──
    location = /ws {
      access_log /var/log/nginx/websocket.log;
      proxy_pass http://gateway:8000;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header Host $host;

      proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;  # // NEW
      proxy_set_header   X-Forwarded-Proto $scheme;                      # // NEW
      proxy_read_timeout  60s;                                           # // NEW
      proxy_send_timeout  60s; 

      proxy_hide_header Content-Security-Policy;
      proxy_hide_header X-Content-Type-Options;
      proxy_hide_header X-Frame-Options;
      proxy_hide_header Referrer-Policy;
      proxy_hide_header Cross-Origin-Resource-Policy;
    }

    # ── Grafana : https://localhost:8443/grafana/ ──
    location /grafana/ {
      # Preserve the incoming path when proxying so Grafana receives /grafana/... as expected
      # (proxy_pass without a URI appends the original request URI)
      proxy_pass http://grafana:3000;
      proxy_http_version 1.1;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;

      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      # Disable nginx-side redirect rewriting; Grafana will use GF_SERVER_ROOT_URL to build redirects
      proxy_redirect off;
    }

    # ── Prometheus : https://localhost:8443/prometheus/ ──
    location /prometheus/ {
      rewrite ^/prometheus/(.*) /$1 break;
      proxy_pass http://prometheus:9090;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ── Kibana : https://localhost:8443/kibana/ ──
    location /kibana/ {
      # Keep the /kibana/ prefix so Kibana (server.basePath) receives the expected path
  # Preserve the original request URI so Kibana receives /kibana/... (do NOT use trailing slash)
  proxy_pass http://kibana:5601;
      proxy_http_version 1.1;

      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port $server_port;
  # Do not modify the request path; Kibana is configured with server.basePath

      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_read_timeout 90s;
      proxy_redirect off;
    }

    # ── Alertmanager : https://localhost:8443/alertmanager/ ──
    location /alertmanager/ {
      rewrite ^/alertmanager/(.*) /$1 break;
      proxy_pass http://alertmanager:9093;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    access_log /var/log/nginx/access.json json;
  }
}

