events {}

http {
  # --- Redirect HTTP -> HTTPS (on garde :8443 comme chez toi) ---
  server {
    listen 80;
    return 301 https://$host:8443$request_uri;
  }

  # --- Upgrade header -> Connection mapping (comme chez toi) ---
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  # --- Request ID (comme chez toi) ---
  map $request_id $req_id {
    default $request_id;
  }

  # --- Origin strict pour WebSocket (nouveau) ---
#  map $http_origin $ws_ok {
#    default 0;
#    "${FRONTEND_ORIGIN}" 1;
#  }

  # --- Log JSON (comme chez toi) ---
  log_format json escape=json
    '{ "time":"$time_local","remote_addr":"$remote_addr","request_id":"$req_id",'
    '"method":"$request","status":$status,"body_bytes_sent":$body_bytes_sent,'
    '"request_time":$request_time,"upstream_time":"$upstream_response_time" }';

  server {
    listen 443 ssl;
    server_name localhost;

    # --- Certs (tes chemins/noms) ---
    ssl_certificate     /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # --- Security headers (tes en-têtes) ---
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; connect-src 'self' https://$host wss://$host; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'" always;

    # --- Proxy headers (tes en-têtes) ---
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;


    # --- Health ---
    location = /healthz { return 200;
    }

    # --- METRICS (exact) -> GATEWAY ---
    location = /metrics {
      ${ALLOW_DIRECTIVES}
      deny all;

      proxy_pass http://gateway:8000;   # garde /metrics (match exact)
      proxy_http_version 1.1;
      proxy_intercept_errors off;
    }
    # --- API HTTP -> GATEWAY ---
    location /api/ {
      ${ALLOW_DIRECTIVES}
      deny all;

      proxy_pass http://gateway:8000;
      proxy_http_version 1.1;
    }

    # --- WebSocket (Origin strict + timeouts) ---
    location /ws {
      if ($scheme != "https") { return 403; }
      if ($http_origin = "") { return 403; }
      if ($http_origin !~* ^https://$host(:\d+)?$) { return 403; }

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;

      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_read_timeout    86400s;
      proxy_send_timeout    86400s;
      proxy_connect_timeout 30s;
      proxy_buffering off;
      proxy_cache     off;

      proxy_pass http://gateway:8000;
    }

          # --- Page de test WS (bypass SPA) ---
    # Page de test (depuis le service frontend)
    location = /ws-test.html {
      proxy_pass http://frontend:80/ws-test.html;
      proxy_http_version 1.1;
      proxy_intercept_errors off;
      add_header X-Debug-Location "frontend-ws-test" always;
    }

    # Alias court (sert direct la page de test, pas de 302)
    location = /test-ws {
      proxy_pass http://frontend:80/ws-test.html;
      proxy_http_version 1.1;
      proxy_intercept_errors off;
      add_header X-Debug-Location "frontend-ws-alias" always;
    }


    # --- FRONTEND (statique) ---
    location = /index.html {
      proxy_pass http://frontend:80/index.html;
      proxy_http_version 1.1;
    }

    location / {
      proxy_pass http://frontend:80;
      proxy_http_version 1.1;
      proxy_intercept_errors on;
      error_page 404 = /index.html;   # fallback SPA
      add_header X-Debug-Location "frontend-root" always;
    }

    # --- Logs JSON + propagation Request-ID ---
    access_log /var/log/nginx/access.json json;
    proxy_set_header X-Request-ID $req_id;
    add_header     X-Request-ID $req_id always;
  }
}
