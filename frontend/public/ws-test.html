<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>WebSocket Test Client</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; max-width: 900px; margin: 0 auto; padding: 20px; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input, button { padding: 8px 10px; }
    input[type="text"] { min-width: 320px; flex: 1; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .status { padding: 8px 10px; margin: 10px 0; font-weight: 600; border-radius: 6px; background: #f5f5f5; }
    .messages { height: 320px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin: 10px 0; background: #fff; }
    .message { margin: 6px 0; padding: 6px 8px; border-left: 3px solid #e5e7eb; background: #fafafa; border-radius: 4px; }
    .message.client { border-left-color: #3b82f6; background: #f0f7ff; }
    .message.server { border-left-color: #10b981; background: #f0fff7; }
    .message.system { border-left-color: #9ca3af; background: #f7f7f7; font-style: italic; }
    .timestamp { color: #666; font-size: 12px; margin-top: 2px; }
    .help { margin-top: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: #fcfcfc; }
    code { background: #f3f4f6; padding: 1px 4px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>WebSocket Test Client</h1>

  <section>
    <h3>Connexion</h3>
    <div class="row">
      <input type="text" id="wsUrl" placeholder="WebSocket URL (wss://host:port/ws)" />
      <button id="connectBtn" onclick="connect()">Se connecter</button>
      <button id="disconnectBtn" onclick="disconnect()" disabled>Se d√©connecter</button>
      <label style="display:flex;align-items:center;gap:6px">
        <input type="checkbox" id="autoReconnect" />
        Auto-reconnect
      </label>
    </div>
    <div id="status" class="status">üî¥ D√©connect√©</div>
  </section>

  <section>
    <h3>Messages</h3>
    <div id="messages" class="messages"></div>
    <div class="row">
      <input type="text" id="messageInput" placeholder='Ex: {"type":"ws.ping","requestId":"test"}' disabled />
      <button id="sendBtn" onclick="sendMessage()" disabled>Envoyer</button>
      <button onclick="clearMessages()">Effacer</button>
    </div>
  </section>

  <section class="help">
    <strong>Conseils :</strong>
    <ul>
      <li>L‚ÄôURL se remplit automatiquement : <code>wss://&lt;host:port&gt;/ws</code>. Vous pouvez la modifier (ex : <code>/ws-debug</code>).</li>
      <li>En cas de 403 : v√©rifiez l‚Äôallowlist IP (inclure <code>127.0.0.1</code> et <code>::1</code>) et la r√®gle d‚Äô<em>Origin</em> c√¥t√© proxy.</li>
      <li>En cas de 400/502 : v√©rifiez la conf Nginx (Upgrade/Connection) et la reachabilit√© de <code>gateway:8000</code>.</li>
    </ul>
  </section>

  <script>
    let ws = null;
    let isConnected = false;
    let reconnectTimer = null;

    function now() { return new Date().toLocaleTimeString(); }
    function setDisabled(id, v) { const el = document.getElementById(id); if (el) el.disabled = v; }

    function updateStatus(text) {
      document.getElementById('status').textContent = text;
    }

    function addMessage(content, kind = 'system') {
      const wrap = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = `message ${kind}`;
      div.innerHTML = `<div>${content}</div><div class="timestamp">${now()}</div>`;
      wrap.appendChild(div);
      wrap.scrollTop = wrap.scrollHeight;
    }

    function computeWsUrl() {
      const proto = (location.protocol === 'https:') ? 'wss:' : 'ws:';
      // location.host inclut d√©j√† le port (ex: localhost:8443)
      return `${proto}//${location.host}/ws`;
    }

    // Pr√©-remplir l‚ÄôURL √† l‚Äôouverture
    (function initUrl() {
      const input = document.getElementById('wsUrl');
      if (input && !input.value.trim()) {
        input.value = computeWsUrl();
      }
    })();

    function connect() {
      const url = document.getElementById('wsUrl').value.trim();
      if (!url) { addMessage('‚ö†Ô∏è URL vide', 'system'); return; }

      // Nettoyer l‚Äôancienne connexion
      if (ws) { try { ws.close(); } catch (_) {} ws = null; }

      updateStatus('üü° Connexion en cours‚Ä¶');
      addMessage(`üîÑ Tentative de connexion √† : <code>${url}</code>`, 'system');

      try {
        ws = new WebSocket(url);

        ws.onopen = () => {
          isConnected = true;
          updateStatus('üü¢ Connect√© (101 Switching Protocols)');
          addMessage('‚úÖ Connect√©', 'system');
          setDisabled('connectBtn', true);
          setDisabled('disconnectBtn', false);
          setDisabled('messageInput', false);
          setDisabled('sendBtn', false);
          if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
        };

        ws.onmessage = (evt) => addMessage(`üì© ${evt.data}`, 'server');

        ws.onclose = (evt) => {
          isConnected = false;
          updateStatus('üî¥ D√©connect√©');
          addMessage(`‚ùå Fermeture (code=${evt.code}, raison="${evt.reason || 'n/a'}")`, 'system');
          setDisabled('connectBtn', false);
          setDisabled('disconnectBtn', true);
          setDisabled('messageInput', true);
          setDisabled('sendBtn', true);

          if (document.getElementById('autoReconnect').checked) {
            if (!reconnectTimer) {
              reconnectTimer = setTimeout(() => {
                reconnectTimer = null;
                connect();
              }, 1500);
              addMessage('‚è≥ Reconnexion automatique dans 1.5s‚Ä¶', 'system');
            }
          }
        };

        ws.onerror = () => {
          updateStatus('‚ùå Erreur');
          addMessage('üí• Erreur WebSocket (regarder Network ‚Üí WS pour le code HTTP).', 'system');
        };
      } catch (err) {
        updateStatus('‚ùå Erreur');
        addMessage(`üí• Exception WebSocket: ${String(err)}`, 'system');
      }
    }

    function disconnect() {
      if (ws) {
        try { ws.close(1000, 'Disconnected by user'); } catch (_) {}
      }
    }

    function sendMessage() {
      const input = document.getElementById('messageInput');
      const msg = input.value.trim();
      if (!msg) return;
      if (ws && isConnected) {
        ws.send(msg);
        addMessage(`üì§ ${msg}`, 'client');
        input.value = '';
      } else {
        addMessage('‚ö†Ô∏è Non connect√©', 'system');
      }
    }

    function clearMessages() {
      document.getElementById('messages').innerHTML = '';
    }

    // Enter pour envoyer
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
